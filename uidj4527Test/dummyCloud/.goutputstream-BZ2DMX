<?phprequire('id3v2/id3.class.php');/*define ( 'MYSQL_HOST', 'localhost' );define ( 'MYSQL_USER', 'root' );define ( 'MYSQL_PW',   'gH648aT' );define ( 'MYSQL_DB',   'cloudmetadata' );*/
//uidj4527 use my own database
define ( 'MYSQL_HOST', 'sql311.hostfreeweb.net' );define ( 'MYSQL_USER', 'freehs_15315520' );define ( 'MYSQL_PW',   'ray0803226' );define ( 'MYSQL_DB',   'freehs_15315520_mp3' );define ("MIME_TYPE_AUDIO_MPEG", "audio/mpeg");define ( 'PATH',   '/music/' );define ( 'HTTP',   'http://' );define ( 'UNKNOWN_STRING', "Unknown"); /**  * Creates all neccessary MySQL relations  */function createTables() {	$db_link = @mysql_connect (MYSQL_HOST,  MYSQL_USER,  MYSQL_PW);		if ($db_link) {		$db_sel = mysql_SELECT_db (MYSQL_DB, $db_link);				if ($db_sel) {			$sql = "CREATE TABLE IF NOT EXISTS `metadata` (				  `id` int(11) NOT NULL AUTO_INCREMENT,				  `path` varchar(1024) NOT NULL,				  `streamingURL` varchar(1024) NOT NULL,				  `lastfmURL` varchar(1024) NOT NULL,				  `modified` datetime NOT NULL,				  `artist` varchar(128) NOT NULL,				  `title` varchar(128) NOT NULL,				  `genre` varchar(128) NOT NULL,				  `albumname` varchar(128) NOT NULL,				  PRIMARY KEY (`id`)				) ENGINE=InnoDB  DEFAULT CHARSET=latin1";						mysql_query( $sql );					$sql = "CREATE TABLE IF NOT EXISTS `user` (				  `ci_session_id` varchar(40) NOT NULL,				  `dropbox_user_id` int(11) NOT NULL,				  `id` int(11) NOT NULL,				  PRIMARY KEY (`id`)				) ENGINE=InnoDB DEFAULT CHARSET=latin1";						mysql_query( $sql );					$sql = "ALTER TABLE `user`					ADD CONSTRAINT `user_ibfk_1` FOREIGN KEY (`id`) REFERENCES `metadata` (`id`) ON DELETE CASCADE;";						mysql_query( $sql );						$sql = "CREATE TABLE IF NOT EXISTS `dummy` (				  `path` varchar(1024) NOT NULL,				  `modified` datetime NOT NULL				) ENGINE=InnoDB DEFAULT CHARSET=latin1";						mysql_query( $sql );		}  } else {  echo 'failure'; }	}function getFilesFromDir(&$metadata_ref, $path_param, $db_sel_param, $userid_param) {		echo 'Test';	$dir = openDir(".".$path_param);			while (false !== ($file = readdir($dir))) {				if ($file != "." && $file != "..")		{								if(is_dir(".".$path_param.$file)) {                 $dir2 = $path_param.$file;                                 getFilesFromDir($metadata_ref, $dir2."/", $db_sel_param, $userid_param); 				            } else {            									$finfo = finfo_open(FILEINFO_MIME_TYPE);				$mime  = finfo_file($finfo, ".".$path_param.$file);								$mystring     = HTTP.$_SERVER['SERVER_NAME'].$_SERVER['REQUEST_URI'];								$streamingURL = substr($mystring, 0, strrpos($mystring, "/")).$path_param.$file;//				$streamingURL = "file:///usr/bin/OIP_REF_HMI/ORH_HMI/HMI_Cloudplayer/uidj4527Test/dummyCloud/music/".$path_param.$file;														if ($mime==MIME_TYPE_AUDIO_MPEG) {									$myId3 = new ID3(".".$path_param.$file);										// extract Id3v2 metadata from file - only the first couple of bytes are read - not the complete file					if ($myId3->getInfo()){						$id3_tag_artist  = $myId3->getArtist();						$id3_tag_album   = $myId3->getAlbum();						$id3_tag_gender  = $myId3->getGender();												if ($id3_tag_artist != false && $id3_tag_album != false) {							$lastfmURL = "http://ws.audioscrobbler.com/2.0/?method=album.getinfo&api_key=507c7a9240a4794851afa81b8af14632&artist=".$myId3->getArtist()."&album=".$myId3->getAlbum();						} else {							$lastfmURL = UNKNOWN_STRING;							}												if ($id3_tag_gender == false) {							$id3_tag_gender = UNKNOWN_STRING;							}												if ($id3_tag_artist == false) {							$id3_tag_artist = UNKNOWN_STRING;							}												// store meta data into database - info will be used at delta sync						if ($db_sel_param) {							$sql = "INSERT INTO metadata (path, streamingURL, lastfmURL, modified, artist, title, genre, albumname) VALUES ('"							.mysql_real_escape_string($path_param.$file)."','"							.mysql_real_escape_string($streamingURL)."','"							.mysql_real_escape_string($lastfmURL)."','"							." date','"							.mysql_real_escape_string($id3_tag_artist)."','"							.mysql_real_escape_string($myId3->getTitle())."','"							.mysql_real_escape_string($id3_tag_gender)."','"							.mysql_real_escape_string($myId3->getAlbum())."')";														$result = mysql_query( $sql );  // finally do the query														if (!$result)								echo mysql_error();							else							{								$id     = mysql_insert_id();								$sql    = "INSERT INTO user (id, ci_session_id, dropbox_user_id) VALUES ('".$id."','"."0"."','".$userid_param."')";								$result = mysql_query( $sql );  // finally do the query							}						}																														$metadata_ref[] = array('path'       => $path_param.$file, 									        'streamingURL'   => $streamingURL, 											'lastfmURL'      => $lastfmURL,											'coverArtUrl'    => "",											'modified'       => "modified",											'userid'         => "1",											'artist'         => htmlentities($id3_tag_artist),											'title'          => htmlentities($myId3->getTitle()),											'genre'          => htmlentities($id3_tag_gender),											'albumname'      => htmlentities($myId3->getAlbum()));																																																}				}			}		}	}		closeDir($dir);	} /*****************************//* FULL SYNC IMPLEMENTAITON  *//*****************************/$userid = $_GET["userid"]; // extract user id from url parameter	date_default_timezone_set('Europe/Berlin'); createTables();// connect to MySQL database$db_link = @mysql_connect (MYSQL_HOST,  MYSQL_USER,  MYSQL_PW);// doing a full sync so make a hard clean up and delete everything for this userid firstif ($db_link) {	$db_sel = mysql_SELECT_db (MYSQL_DB, $db_link);		if ($db_sel) {		$sql = "DELETE FROM metadata WHERE id IN (SELECT id FROM user WHERE dropbox_user_id=".$userid.")";		$result = mysql_query( $sql );					$sql = "DELETE FROM user where dropbox_user_id=".$userid;		$result = mysql_query( $sql );				}}$metadata = array();getFilesFromDir($metadata, PATH, $db_sel, $userid);	if (isset($metadata)) {		echo json_encode($metadata);}	?>